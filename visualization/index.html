<html>

<head>
    <meta charset="utf-8">
    <title>HonestNFT Data Visualization</title>
<meta content="width=device-width,initial-scale=1" name="viewport" />
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vue-lazyload/vue-lazyload.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ant-design-vue@1.7.2/dist/antd.min.css">
    <script src="https://cdn.jsdelivr.net/npm/ant-design-vue@1.7.2/dist/antd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://unpkg.com/vue-router/dist/vue-router.js"></script>

    <!-- Resources -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/v-charts/lib/index.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/v-charts/lib/style.min.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-apexcharts@1.6.2/dist/vue-apexcharts.min.js"></script>

    <script src="https://d3js.org/d3.v4.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y2RJYV95DZ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-Y2RJYV95DZ');
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <style>
        body , pre {
            font-family: 'courier new', courier-ps-w01, courier-ps-w02, courier-ps-w10, monospace
        }

        h2 {
            font-size: 1.8rem;
        }
    </style>
</head>

<body>
    <div id="app">
        <a-modal v-model="showCreate" title="Add Collection"  @ok="handleAdd">
            <!-- <p><a-input  v-model="create.name" placeholder="Collection Name" /></p> -->
            <p><a-input v-model="create.link"  placeholder="Opensea link eg.(https://opensea.io/collection/wilderworld)" /></p>
        </a-modal>
        <a-layout id="components-layout-demo-top-side">
            <a-layout-header class="header" style="background: black; height: 80px; line-height: 80px;">
                <router-link to="/">
                    <div style="color: white; text-align: center; font-size: 30px;">HonestNFT Analytics</div>
                </router-link>
            </a-layout-header>
            <a-layout-content style="padding: 0 20px">
                <a-layout :style="isMobile ? `padding: 0px 0; margin: 30px auto; background: #fff` : `padding: 0px; width: 1300px; margin: 30px auto; background: rgb(255, 255, 255);`">
                    <a-layout-content :style="isMobile ?  { padding: '15px 15px', minHeight: '500px' } : { padding: '40px 40px', minHeight: '680px' }">
                        <a-spin :spinning="loading" />
                        <div class="block-item" v-if="!isDetail">
                            <div  style="text-align: right">
                                <a-button @click="showCreate = true">Add Collection</a-button>
                            </div>
                            <h2>Collections</h2>
                            <a-row :gutter="25">
                                <a-col>
                                    <a-table :columns="taskTable.columns" :data-source="taskTable.data"
                                        :pagination="false" bordered />
                                </a-col>
                            </a-row>
                        </div>
                        <div class="block-item" v-if="isDetail">
                            <div style="border-bottom: 1px solid #eee; margin-bottom: 50px" v-if="currentCollection">
                                <h2 style="margin-bottom: 40px;">
                                    <img :src="currentCollection.logo" height="85" style="margin-right: 10px"> {{ currentCollection.name }}
                                </h2>
                            </div>
                            <p style="text-align: center;">
                                <a-spin v-if="!current" style="margin-top: 100px" />
                            </p>
                            <h2 v-if="current">Rarity Map</h2>
                            <div id="my_dataviz"></div>

                            <h2 v-if="current" style="margin-top: 30px">Mint histogram</h2>
                            <apexchart type="line" v-if="current" height="500" :options="mintHistory.chartOptions"
                                :series="mintHistory.series"></apexchart>

                            <h2 v-if="current" style="margin-top: 30px">Sale histogram</h2>
                            <apexchart type="line" v-if="current" height="500" :options="saleHistory.chartOptions"
                                :series="mintHistory.series">
                            </apexchart>

                            <h2 v-if="current" style="margin-top: 30px">Top Buyers(order by total sold price)</h2>
                            <a-table v-if="current" :columns="topBuyerTable.columns" :data-source="topBuyerTable.data"
                                :pagination="false" bordered size="medium"/>

                        </div>
                    </a-layout-content>
                </a-layout>
            </a-layout-content>
            <a-layout-footer style="text-align: center">
                Made By <a href="https://twitter.com/lljxx1" target="_blank">fun</a>
            </a-layout-footer>
        </a-layout>

    </div>
    <script>
        Vue.use(VueRouter);


        function getBuyerInfo(mintings, sales) {
            // group by tokenId
            const saleByTokenId = sales.reduce((total, item) => {
                const { TOKEN_ID } = item;
                if (item.payment_token == "ETH") {
                    total[TOKEN_ID] = total[TOKEN_ID] || [];
                    total[TOKEN_ID].push(item);
                    item.amount = item.price / 1e18;
                }
                return total;
            }, {});

            const mintingWithSalePrice = mintings
                .map((_) => {
                    const { TOKEN_ID } = _;
                    const sales = saleByTokenId[TOKEN_ID] || [];
                    // check seller is minting account
                    _.sales = sales.filter(
                        (sale) => sale.seller == _.to_account);
                    if (sales.length) {
                        _.sale_price = sales[0].amount;
                    } else {
                        _.sale_price = 0;
                    }
                    return _;
                })
                .filter((_) => _.sales.length)
                .sort((a, b) => b.sale_price - a.sale_price);

            const groupByAccounts = mintingWithSalePrice.reduce((total, miting) => {
                const { to_account } = miting;
                total[to_account] = total[to_account] || [];
                total[to_account].push(miting);
                return total;
            }, {});

            const buyers = Object.keys(groupByAccounts)
                .map((_) => {
                    return {
                        account: _,
                        mintings: groupByAccounts[_],
                    };
                })
                .map((_) => {
                    _.total_sale_amount = _.mintings.reduce(
                        (total, item) => total + item.sale_price,
                        0
                    );
                    return {
                        account: _.account,
                        total_sale_amount: _.total_sale_amount,
                        mintings_count: _.mintings.length,
                        mintings: _.mintings.map(_ => {
                            return {
                                TOKEN_ID: _.TOKEN_ID,
                                rank: _.rank,
                                sale_price: _.sale_price,
                            };
                        }).slice(0, 3)
                    };
                })
                .sort((a, b) => b.total_sale_amount - a.total_sale_amount);

            const topBuyers = buyers.filter((_) => _.total_sale_amount > 1).slice(0, 50);
            return {
                topBuyers,
            };
        }

        const routes = [
            { path: '/' },
            { path: '/collection/:slug', name: 'Detail' }
        ]

        const router = new VueRouter({
            routes: routes
        })

        var app = new Vue({
            router,
            el: '#app',
            components: {
                apexchart: VueApexCharts,
            },
            data: {
                create: {
                    name: null,
                    link: null
                },
                showCreate: false,
                isMobile: window.innerWidth < 800,
                loading: true,
                collections: [],
                current: null,
                buyerInfo: null
            },

            computed: {
                saleHistory() {
                    const series = []
                    let byHours = []
                    if (this.current) {
                        const { saleWithRarity } = this.current;
                        byHours = saleWithRarity.reduce((state, item) => {
                            const dateTime = moment(item.time).format("YYYY-MM-DD HH:00");
                            if (!state.map.hasOwnProperty(dateTime)) {
                                state.map[dateTime] = state.rows.length;
                                state.rows.push({
                                    date: dateTime,
                                    count: 1
                                })
                            } else {
                                const index = state.map[dateTime]
                                state.rows[index].count++;
                            }
                            return state;
                        }, {
                            map: {},
                            rows: []
                        }).rows;

                        console.log(byHours)
                        series.push({
                            name: 'Count',
                            data: byHours.map(_ => _.count)
                        })
                    }
                    console.log(series)
                    return {
                        series,
                        chartOptions: {
                            chart: {
                                height: 350,
                                type: 'area'
                            },
                            dataLabels: {
                                enabled: false
                            },
                            stroke: {
                                curve: 'smooth'
                            },
                            xaxis: {
                                categories: byHours.map(_ => _.date)
                            },
                            tooltip: {
                                x: {
                                    format: 'dd/MM/yy HH:mm'
                                },
                            },
                        },
                    }

                },
                mintHistory() {
                    const series = []
                    let byHours = []
                    if (this.current) {
                        const { mintingRows } = this.current;
                        byHours = mintingRows.reduce((state, item) => {
                            const dateTime = moment(item.time).format("YYYY-MM-DD HH:00");
                            if (!state.map.hasOwnProperty(dateTime)) {
                                state.map[dateTime] = state.rows.length;
                                state.rows.push({
                                    date: dateTime,
                                    count: 1
                                })
                            } else {
                                const index = state.map[dateTime]
                                state.rows[index].count++;
                            }
                            return state;
                        }, {
                            map: {},
                            rows: []
                        }).rows;

                        console.log(byHours)
                        series.push({
                            name: 'Count',
                            data: byHours.map(_ => _.count)
                        })
                    }
                    console.log(series)
                    return {
                        series,
                        chartOptions: {
                            chart: {
                                height: 350,
                                type: 'area'
                            },
                            dataLabels: {
                                enabled: false
                            },
                            stroke: {
                                curve: 'smooth'
                            },
                            xaxis: {
                                categories: byHours.map(_ => _.date)
                            },
                            tooltip: {
                                x: {
                                    format: 'dd/MM/yy HH:mm'
                                },
                            },
                        },
                    }

                },
                rarityMap() {
                    const series = []
                    if (this.current) {
                        const { mintingRows } = this.current;
                        series.push({
                            name: 'Name',
                            data: mintingRows.map(_ => [parseInt(_.TOKEN_ID), parseInt(_.rank)])
                        })
                    }
                    console.log(series)
                    return {
                        series,
                        chartOptions: {
                            chart: {
                                height: 500,
                                type: 'scatter',
                                zoom: {
                                    enabled: true,
                                    type: 'xy'
                                }
                            },
                            xaxis: {
                                tickAmount: 10,
                                labels: {
                                    formatter: function (val) {
                                        return parseFloat(val).toFixed(1)
                                    }
                                }
                            },
                            yaxis: {
                                tickAmount: 7
                            }
                        },
                    }

                },
                currentCollectionDetail() {
                    return
                },

                currentCollection() {
                    if (!this.isDetail) {
                        return null
                    }
                    return this.collections.find(_ => _.slug == this.$route.params.slug)
                },
                isDetail() {
                    return this.$route.name == 'Detail'
                },
                topBuyerTable() {
                    const h = this.$createElement
                    return {
                        columns: [
                            {
                                title: 'Address',
                                dataIndex: 'account',
                            },
                            {
                                title: 'Total Sold Price',
                                dataIndex: 'total_sale_amount',
                                customRender:(text) => {
                                    return text.toFixed(2) + ' ETH'
                                }
                            },
                            {
                                title: 'Mints',
                                dataIndex: 'mintings_count',
                            }, {
                                title: 'Sample Token',
                                customRender: (text, row, index) => {
                                    return h('div', {
                                        attrs: {
                                            // style: "max-width: 300px"
                                        }
                                    },
                                        [
                                            h('pre', {
                                            },
                                                [
                                                    JSON.stringify(row.mintings, null, 2)
                                                ]),
                                        ])
                                },
                            }
                        ],
                        data: this.buyerInfo ? this.buyerInfo.topBuyers : []
                    }
                },
                taskTable() {
                    const h = this.$createElement
                    return {
                        columns: [
                            {
                                title: '#',
                                customRender: (text, row, index) => {
                                    return index+1
                                }
                            },
                            {
                                title: 'Collection',
                                dataIndex: 'logo',
                                with: '400',
                                customRender: (text, row, index) => {
                                    return h('div', {
                                        attrs: {
                                            // style: "max-width: 300px"
                                        }
                                    },
                                        [
                                            h('a', {
                                                attrs: {
                                                    href: `#/collection/${row.slug}`
                                                }
                                            },

                                                [
                                                    h('img', {
                                                        attrs: {
                                                            src: text,
                                                            width: 100,
                                                            style: "margin-right: 10px; width: 100px; min-height: 100px"
                                                        }
                                                    }),
                                                    h('span', {
                                                        attrs: {
                                                            style: "font-weight: bold"
                                                        }
                                                    },
                                                        [row.name])
                                                ])
                                        ]
                                    )
                                },
                            },
                            {
                                title: 'Total Supply',
                                dataIndex: 'totalSupply',
                            },
                            {
                                title: 'Total Volume',
                                dataIndex: 'totalVolume',
                            },
                            {
                                title: 'Detail',
                                customRender: (text, row, index) => {
                                    return h('div', {
                                        attrs: {
                                            // style: "max-width: 300px"
                                        }
                                    },
                                        [
                                            h('a', {
                                                attrs: {
                                                    href: row.opensea,
                                                    target: "_blank",
                                                    style: "margin-right: 10px"
                                                }
                                            },
                                                [
                                                    'Opensea'
                                                ]),
                                        ])
                                },
                            }
                        ],
                        data: this.collections
                    }
                },
            },
            watch: {
                $route() {
                    this.loadCollection()
                }
            },
            mounted() {
                console.log(this.$router)
                this.loadData();
                
            },
            methods: {

                async handleAdd() {
                    const { name, link } = this.create 
                    if (link.indexOf('https://opensea.io/collection/') == -1) {
                        this.$message.error('It\'s not opensea collection link');
                        return
                    }
                    const slug = link.split('https://opensea.io/collection/')[1].trim()
                    const colecction = {
                        // name,
                        slug
                    }

                    const { data } = await axios.get('https://honestnftapi.mywallet.tools/api/addCollection', {
                        params: colecction
                    })
                    if (data.error) {
                        this.$message.error(data.msg);
                        return
                    }

                    this.$message.success('Collection submitted,');
                    this.showCreate = false;
                },
                async loadCollection() {
                    const slug = this.$route.params.slug
                    const collection = this.currentCollection
                    console.log('collection', collection)
                    const { data } = await axios.get('https://honestnftapi.mywallet.tools/api/getCollection', {
                        params: {
                            slug,
                            bucket: collection ? collection.bucket : '',
                        }
                    })
                    this.current = data.result;
                    this.buyerInfo = getBuyerInfo(this.current.mintingRows, this.current.saleWithRarity);
                    this.$nextTick(() => {
                        this.renderMap()
                    })
                    console.log('loadCollection', slug, data, this.buyerInfo)
                },
                async loadData() {
                    const { data } = await axios.get('https://honestnftapi.mywallet.tools/api/getAllCollection')
                    this.collections = data.collections.reverse()
                    this.loading = false;
                    console.log(this.collections)
                    if (this.isDetail) {
                        this.loadCollection()
                    }
                },
                renderMap() {
                    // set the dimensions and margins of the graph
                    var margin = { top: 10, right: 30, bottom: 30, left: 40 },
                        width = document.querySelector('#my_dataviz').offsetWidth - margin.left - margin.right,
                        height = 350 - margin.top - margin.bottom;

                    // append the svg object to the body of the page
                    var svg = d3.select("#my_dataviz")
                        .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform",
                            "translate(" + margin.left + "," + margin.top + ")");

                    const { mintingRows } = this.current;
                    const data = mintingRows

                    console.log('mintingRows', mintingRows)

                    // Add X axis
                    var x = d3.scaleLinear()
                        .domain([0, mintingRows.length + 200])
                        .range([0, width]);
                    svg.append("g")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x));

                    // Add Y axis
                    var y = d3.scaleLinear()
                        .domain([0, mintingRows.length])
                        .range([height, 0]);
                    svg.append("g")
                        .call(d3.axisLeft(y));


                    // Add dots
                    svg.append('g')
                        .selectAll("dot")
                        .data(data)
                        .enter()
                        .append("circle")
                        .attr("cx", function (d) { return x(d.TOKEN_ID); })
                        .attr("cy", function (d) { return y(d.rank); })
                        .attr("r", 1.5)
                        .style("fill", "#40a9ff")
                }
            },
        })


    </script>
</body>

</html>